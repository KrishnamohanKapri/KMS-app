<div class="page-wrapper" #printArea>
  <mat-card class="order-details-card">
    <mat-card-title>Order Details</mat-card-title>
    <mat-card-subtitle>Order ID: {{ order.orderId }}</mat-card-subtitle>

    <div class="status-update-row">
      <span><mat-icon color="primary">info</mat-icon> <strong>Status:</strong> {{ order.status }}</span>
      <button *ngIf="(userRole === 'admin' || userRole === 'employee') ||
                (userRole === 'chef' && (order.status === 'confirmed' || order.status === 'preparing')) ||
                (userRole === 'rider' && (order.status === 'ready' || order.status === 'in-delivery')) &&
                order.status !== 'delivered'" mat-raised-button color="accent" class="update-status-btn"
        (click)="openUpdateStatusDialog()">
        <mat-icon>edit</mat-icon> Update Status
      </button>
    </div>

    <mat-divider></mat-divider>
    <app-delivery *ngIf="order._id && order.status === 'in-delivery'"
      [orderAddress]="getSerializedOrderDeliveryAddress()" [orderId]="order._id"></app-delivery>
    <mat-divider></mat-divider>

    <!-- Customer Info -->
    <section class="section card-section">
      <h3>Customer Info</h3>
      <div class="customer-info">
        <p><mat-icon>person</mat-icon> <strong>Name:</strong> {{ order.billingInfo?.firstName + ' ' +
          order.billingInfo?.lastName }}</p>
        <p><mat-icon>home</mat-icon> <strong>Billing Address:</strong> {{ order.billingInfo?.address?.street + ', ' +
          order.billingInfo?.address?.city + ', ' + order.billingInfo?.address?.zipCode + ', ' +
          order.billingInfo?.address?.state + ', ' + order.billingInfo?.address?.country }}</p>
        <p><mat-icon>location_on</mat-icon> <strong>Delivery Address:</strong> {{ order.deliveryAddress?.street + ', ' +
          order.deliveryAddress?.city + ', ' + order.deliveryAddress?.zipCode + ', ' + order.deliveryAddress?.state + ',
          ' + order.deliveryAddress?.country }}</p>
        <p><mat-icon>phone</mat-icon> <strong>Contact No:</strong> {{ order.billingInfo?.phone }}</p>
      </div>
    </section>

    <mat-divider></mat-divider>

    <!-- Meals -->
    <section class="section card-section">
      <h3>Meals</h3>
      <table mat-table [dataSource]="order.meals!" class="mat-elevation-z1 meals-table">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Meal</th>
          <td mat-cell *matCellDef="let meal">{{ meal.mealDetails.title }}</td>
        </ng-container>
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Qty</th>
          <td mat-cell *matCellDef="let meal">{{ meal.qty }}</td>
        </ng-container>
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price (€)</th>
          <td mat-cell *matCellDef="let meal">{{ meal?.mealDetails.price }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['name','quantity','price']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['name','quantity','price']"></tr>
      </table>
    </section>

    <mat-divider></mat-divider>

    <!-- Payment Info -->
    <section class="section card-section">
      <h3>Payment Info</h3>
      <div class="payment-summary">
        <p><mat-icon>payment</mat-icon> <strong>Sub Amount:</strong> €{{ order.total }}</p>
        <p><mat-icon>tax</mat-icon> <strong>Tax:</strong> €{{ order.tax }}</p>
        <p><mat-icon>local_offer</mat-icon> <strong>Discount:</strong> €{{ order.discount }}</p>
        <p><mat-icon>local_shipping</mat-icon> <strong>Delivery Fee:</strong> €{{ order.deliveryFee }}</p>
        <p><mat-icon>attach_money</mat-icon> <strong>Total Amount:</strong> €{{ order.total }}</p>
        <p><mat-icon>info</mat-icon> <strong>Status:</strong> {{ order.status }}</p>
      </div>

      <!-- Payment Details Table -->
      <ng-container *ngIf="payments?.length">
        <h4>Payment(s) Details</h4>
        <table mat-table [dataSource]="payments" class="mat-elevation-z1 payment-table">
          <ng-container matColumnDef="cardType">
            <th mat-header-cell *matHeaderCellDef>Card Type</th>
            <td mat-cell *matCellDef="let payment">{{ payment.paymentDetails?.cardType | titlecase }}</td>
          </ng-container>
          <ng-container matColumnDef="cardBrand">
            <th mat-header-cell *matHeaderCellDef>Card Brand</th>
            <td mat-cell *matCellDef="let payment">{{ payment.paymentDetails?.cardBrand }}</td>
          </ng-container>
          <ng-container matColumnDef="last4Digits">
            <th mat-header-cell *matHeaderCellDef>Last 4 Digits</th>
            <td mat-cell *matCellDef="let payment">{{ payment.paymentDetails?.last4Digits }}</td>
          </ng-container>
          <ng-container matColumnDef="transactionId">
            <th mat-header-cell *matHeaderCellDef>Transaction ID</th>
            <td mat-cell *matCellDef="let payment">{{ payment.paymentDetails?.transactionId }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['cardType','cardBrand','last4Digits','transactionId']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['cardType','cardBrand','last4Digits','transactionId']"></tr>
        </table>
      </ng-container>
    </section>

    <mat-divider></mat-divider>

    <!-- Status Timeline -->
    <section class="section card-section">
      <h3>Status Timeline</h3>
      <div class="timeline-container">
        <div *ngFor="let status of orderTimelineList" class="timeline-item" [ngClass]="status.status">
          <div class="icon"><mat-icon>schedule</mat-icon></div>
          <div class="content">
            <span class="status-text">{{ status.status | titlecase }}</span>
            <span class="timestamp">{{ status.changedAt | date:'medium' }}</span>
          </div>
        </div>
      </div>
    </section>

    <mat-card-actions align="end">
      <button mat-raised-button color="primary" (click)="printSection()">Print</button>
      <button mat-button color="accent" (click)="goBack()">Back</button>
    </mat-card-actions>
  </mat-card>
</div>
